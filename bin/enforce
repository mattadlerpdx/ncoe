#!/bin/bash
# NCOE Enforcer - Run code quality checks
# Usage: ./bin/enforce

set -e

echo "========================================"
echo "NCOE Enforcer"
echo "========================================"
echo

# Change to project root
cd "$(dirname "$0")/.."

# Step 1: Check formatting
echo "[1/3] Checking Go formatting..."
UNFORMATTED=$(gofmt -l . 2>/dev/null | grep -v vendor || true)
if [ -n "$UNFORMATTED" ]; then
    echo "❌ FAIL: The following files are not formatted:"
    echo "$UNFORMATTED"
    echo
    echo "Run: gofmt -w ."
    exit 1
fi
echo "✓ All Go files are formatted"
echo

# Step 2: Run tests
echo "[2/3] Running tests..."
if ! go test ./... -count=1 -short 2>/dev/null; then
    echo "❌ FAIL: Tests failed"
    exit 1
fi
echo "✓ All tests passed"
echo

# Step 3: Run enforcer rules
echo "[3/3] Running enforcer rules..."
go run ./cmd/enforcer

# Exit code is set by enforcer
